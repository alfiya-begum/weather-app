{% extends "base.html" %}
{% block content %}
<div class="card glass-card p-4 mx-auto" style="max-width: 700px;">
  <h2 class="text-center mb-4">{{ city }} Weather</h2>

  <div class="text-center mb-4">
    <i class="bi bi-thermometer-half display-4 text-info"></i>
    <!-- No ° here, added by JS -->
    <h3 id="temperature">{{ weather.temp }}</h3>
    <p class="lead">{{ weather.description | title }}</p>
  </div>

  <div class="row text-center mb-4">
    <div class="col-md-4">
      <i class="bi bi-droplet text-primary"></i>
      <p id="humidity">Humidity: {{ weather.humidity }}%</p>
    </div>
    <div class="col-md-4">
      <i class="bi bi-wind text-secondary"></i>
      <p id="wind">Wind: {{ weather.wind_speed }} m/s</p>
    </div>
    <div class="col-md-4">
      <i class="bi bi-speedometer2 text-danger"></i>
      <p id="pressure">Pressure: {{ weather.pressure }} hPa</p>
    </div>
  </div>

  <!-- Recommendations -->
  <div class="alert alert-info fade-in">
    <i class="bi bi-lightbulb"></i>
    Food: {{ recommendations.food }} <br>
    Clothing: {{ recommendations.clothing }} <br>
    Fitness: {{ recommendations.fitness }} <br>
    Travel: {{ recommendations.travel }} <br>
    Holiday: {{ recommendations.holiday }}
  </div>

  <div class="d-flex justify-content-center gap-3 mt-3">
    <button id="toggleUnit" class="btn btn-light">Toggle Units</button>
    <a href="{{ url_for('index') }}" class="btn btn-light">Back to Home</a>
  </div>

  <canvas id="weatherChart" width="400" height="200" class="mt-4"></canvas>
</div>

<script>
let isCelsius = true;
let weatherData = {
  temp: {{ weather.temp }},
  feels_like: {{ weather.feels_like }},
  temp_min: {{ weather.temp_min }},
  temp_max: {{ weather.temp_max }},
  humidity: {{ weather.humidity }},
  wind_speed: {{ weather.wind_speed }},
  pressure: {{ weather.pressure }}
};

const tempEl = document.getElementById('temperature');
const windEl = document.getElementById('wind');
const humidityEl = document.getElementById('humidity');
const pressureEl = document.getElementById('pressure');

// Conversion helpers
function cToF(c) { return (c * 9/5 + 32).toFixed(1); }
function fToC(f) { return ((f - 32) * 5/9).toFixed(1); }
function msToMph(ms) { return (ms * 2.237).toFixed(1); }
function mphToMs(mph) { return (mph / 2.237).toFixed(1); }
function hpaToInHg(hpa) { return (hpa * 0.02953).toFixed(2); }
function inHgToHpa(inhg) { return (inhg / 0.02953).toFixed(1); }

// Chart setup
const ctx = document.getElementById('weatherChart');
let chart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: ['Temp', 'Feels Like', 'Min', 'Max'],
    datasets: [{
      label: 'Temperature (°C)',
      data: [
        weatherData.temp,
        weatherData.feels_like,
        weatherData.temp_min,
        weatherData.temp_max
      ],
      backgroundColor: ['#0dcaf0', '#6610f2', '#20c997', '#ffc107']
    }]
  },
  options: { responsive: true, plugins: { legend: { display: true } } }
});

// Initial render with degree symbol
tempEl.textContent = weatherData.temp + " °C";

document.getElementById('toggleUnit').addEventListener('click', () => {
  if (isCelsius) {
    // Convert to Imperial
    weatherData.temp = cToF(weatherData.temp);
    weatherData.feels_like = cToF(weatherData.feels_like);
    weatherData.temp_min = cToF(weatherData.temp_min);
    weatherData.temp_max = cToF(weatherData.temp_max);
    tempEl.textContent = weatherData.temp + " °F";
    windEl.textContent = "Wind: " + msToMph({{ weather.wind_speed }}) + " mph";
    pressureEl.textContent = "Pressure: " + hpaToInHg({{ weather.pressure }}) + " inHg";

    chart.data.datasets[0].label = "Temperature (°F)";
    chart.data.datasets[0].data = [
      weatherData.temp,
      weatherData.feels_like,
      weatherData.temp_min,
      weatherData.temp_max
    ];
  } else {
    // Convert back to Metric
    weatherData.temp = fToC(weatherData.temp);
    weatherData.feels_like = fToC(weatherData.feels_like);
    weatherData.temp_min = fToC(weatherData.temp_min);
    weatherData.temp_max = fToC(weatherData.temp_max);
    tempEl.textContent = weatherData.temp + " °C";
    windEl.textContent = "Wind: {{ weather.wind_speed }} m/s";
    pressureEl.textContent = "Pressure: {{ weather.pressure }} hPa";

    chart.data.datasets[0].label = "Temperature (°C)";
    chart.data.datasets[0].data = [
      weatherData.temp,
      weatherData.feels_like,
      weatherData.temp_min,
      weatherData.temp_max
    ];
  }
  chart.update();
  isCelsius = !isCelsius;
});
</script>
{% endblock %}
